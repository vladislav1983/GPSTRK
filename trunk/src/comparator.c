/*=====================================================================================================================
 * 
 * Repository path:     $HeadURL$
 * Last committed:      $Revision$
 * Last changed by:     $Author$
 * Last changed date:   $Date$
 * ID:                  $Id$
 *
 *===================================================================================================================*/
/*=====================================================================================================================
 * Body Identification  
 *===================================================================================================================*/
#ifdef __COMPARATOR_C
    #error "!!! FileName ID. It should be Unique !!!"
#else
    #define __COMPARATOR_C
#endif

/*=====================================================================================================================
 * Included files to resolve specific definitions in this file
 *===================================================================================================================*/
#include "comparator.h"
#include "comparator_mcp.h"


/*=====================================================================================================================
 * Local constants
 *===================================================================================================================*/

/*=====================================================================================================================
 * Local macros
 *===================================================================================================================*/

/*=====================================================================================================================
 * Local types
 *===================================================================================================================*/

/*=====================================================================================================================
 * Local data
 *===================================================================================================================*/

/*=====================================================================================================================
 * Constant Local Data
 *===================================================================================================================*/

/*=====================================================================================================================
 * Constant exported data                                                     
 *===================================================================================================================*/

/*=====================================================================================================================
 * Exported Data
 *===================================================================================================================*/

/*=====================================================================================================================
 * Local Functions Prototypes
 *===================================================================================================================*/


/*=====================================================================================================================
 *
 *                                  E X P O R T E D    F U N C T I O N S
 *
 *===================================================================================================================*/
/*=====================================================================================================================
 * Parameters: void
 *
 * Return: void
 *
 * Description: 
 *===================================================================================================================*/
void Cmp_Init(void)
{
    _DioPinConfig(cDioPin_CompInB, cPinModeInput);
    _DioAnalogConfig(cDioPin_CompInB, cPinModeAnalog);

    // Comparator setup
    CM1CON = CMP_DISABLE                        /* Comparator is disabled */
           | CMP_OUTPUT_DISABLE                 /* Comparator output is internal only */
           | CMP_OUTPUT_NOT_INVERT              /* Comparator output not inverted */
           | CMP_NO_CHANGE
           | CMP_INTERRUPT_ON_ANY_EDGE          /* Interrupt generated on any edge of the selected comparator output*/
           | CMP_POS_IP_CV_Ref                   
           | CMP_NEG_IP_CXINB;   

    // Voltage reference setup
    CVRCON = CMP_VRef_Disable                   /* CVREF circuit powered down */
           | CMP_VRef_OUTPUT_Disable            /* CVREF voltage level is disconnected from CVREF pin */
#if (cComparatorSteps == 24UL)
           | CMP_VRef_SELECT_24_STEPS           /* 0 to 0.67 CVRSRC, with CVRSRC/24 step size */
#else
           | CMP_VRef_SELECT_32_STEPS           /* 0.25 CVRSRC to 0.75 CVRSRC, with CVRSRC/32 step size */
#endif
           | CMP_Vrsrc_AVDD_AVSS;               /* Comparator reference source CVRSRC = AVDD – AVSS */

    // set reference voltage
    CVRCONbits.CVR = ((U16)((cComparatorRefVoltage*cComparatorSteps)/3.300) & 0x000F);

    // set interrupt
    DisableIntCMP;
    CMP_Clear_Intr_Status_Bit;
    SetPriorityIntCMP(cCOMP1_ISR_Priority);

    // enable comparator
    mCMP1_EnblDsbl(1);
    // enable voltage reference
    CVRCON |= CMP_VRef_Enable;

    asm volatile("repeat #40"); //Delay some shit
    Nop();

    mCMP1_Clear_Event;
    CMP_Clear_Intr_Status_Bit;
    EnableIntCMP;
}

/*=====================================================================================================================
 *                                                                            
 *                                     L O C A L    F U N C T I O N S                   
 *                                                                            
 *===================================================================================================================*/
/*=====================================================================================================================
 * Parameters: void
 *
 * Return: void
 *
 * Description: 
 *===================================================================================================================*/
_DECLARE_ISR(_CompInterrupt)
{

     Nop();


    mCMP1_Clear_Event;
    CMP_Clear_Intr_Status_Bit;
}
